# Inngest Job Queue Implementation

**Version:** 1.0.0
**Last Updated:** 2025-09-30
**Status:** Implemented - Ready for Testing

---

## Overview

This document describes the Inngest job queue system implementation for Myxelium's event funnel orchestration. Inngest provides serverless function orchestration with built-in retries, idempotency, and time-based delays.

## Architecture

### Components

```
/inngest
  /client.ts                 # Inngest client configuration
  /functions
    /event-funnel.ts         # Pre-event drip campaign (3 steps)
    /post-event-funnel.ts    # Post-event branching campaigns (2 paths)
    /send-message.ts         # Generic message sender

/app/api/inngest
  /route.ts                  # Inngest webhook handler (Next.js App Router)

/lib/inngest
  /helpers.ts                # Database helpers for message tracking
```

### Event Flow

```
User enrolls
    ↓
POST /api/enrollments
    ↓
event.enrolled (Inngest)
    ↓
Pre-Event Funnel
    ├─ T+0: Welcome email
    ├─ T-24h: Reminder email + SMS
    └─ T-1h: Final reminder email + SMS

Event completes
    ↓
event.completed (Inngest)
    ↓
Post-Event Funnel
    ├─ Attended Path
    │   ├─ T+1h: Thank you email
    │   ├─ T+24h: Resources email
    │   └─ T+3d: Nurture email
    │
    └─ No-show Path
        ├─ T+1h: Sorry we missed you email
        ├─ T+24h: Re-engagement email + SMS
        └─ T+7d: Final follow-up email
```

## Configuration

### Environment Variables

Add these to your `.env.local` file:

```bash
# Inngest Configuration
INNGEST_EVENT_KEY=your-inngest-event-key
INNGEST_SIGNING_KEY=your-inngest-signing-key
```

Get these keys from:
- **Local Development**: Automatically generated by Inngest Dev Server
- **Production**: https://app.inngest.com/env/production/manage/keys

### Database Migration

Run the template migration to add missing message templates:

```bash
# Using Supabase CLI
supabase db push supabase/migrations/20250930_add_inngest_templates.sql

# Or manually run the SQL in your Supabase dashboard
```

This adds the following templates:
- `reminder-1h` - 1-hour email reminder
- `reminder-1h-sms` - 1-hour SMS reminder
- `thank-you` - Thank you email (attended)
- `resources` - Resources email (attended)
- `nurture` - Nurture email (attended)
- `sorry-missed` - Sorry we missed you (no-show)
- `reengagement` - Re-engagement (no-show)
- `final-followup` - Final follow-up (no-show)

## Inngest Functions

### 1. Pre-Event Funnel (`pre-event-funnel`)

**Trigger:** `event.enrolled`

**Sequence:**
1. **Welcome Email (T+0)** - Immediate confirmation with join URL
2. **24h Reminder (T-24h)** - Email + SMS reminder 24 hours before event
3. **1h Reminder (T-1h)** - Final email + SMS reminder 1 hour before event

**Features:**
- Time-based delays using `sleepUntil()`
- Event validation before each step
- Skips reminders if event is cancelled or past
- Consent checking for SMS
- Automatic retry on failures (4 attempts)

**Idempotency:** `${eventId}-${contactId}-${stepType}`

### 2. Post-Event Funnel (`post-event-funnel`)

**Trigger:** `event.completed`

**Branching Logic:**

**Path A - Attended:**
1. **Thank You (T+1h)** - Appreciation email with replay link
2. **Resources (T+24h)** - Slides, materials, recordings
3. **Nurture (T+3d)** - Next steps, offers, engagement

**Path B - No-show:**
1. **Sorry Missed (T+1h)** - Friendly re-engagement with replay
2. **Re-engagement (T+24h)** - Email + SMS with next event invitation
3. **Final Follow-up (T+7d)** - Low-priority resource share

**Features:**
- Automatic branching based on `registration.attended` flag
- Separate sub-functions for each delayed step
- Processes all registrations for an event in parallel
- Records message sends in `sent_messages` table

### 3. Generic Message Sender (`send-message`)

**Trigger:** `message.send`

**Features:**
- Consent checking (email/SMS)
- Template lookup and personalization
- Database tracking (`sent_messages` table)
- Placeholder logging (ready for Resend/Twilio)
- Rate limiting (100 messages/minute)
- Retry policy: 4 attempts with exponential backoff

**Current Behavior:**
- Logs messages to console with full details
- Records in database with status 'sent'
- Returns placeholder provider IDs

**Future Enhancement:**
- Integrate Resend for email delivery
- Integrate Twilio for SMS delivery
- Add actual engagement tracking (opens, clicks)

## Local Development

### 1. Start Inngest Dev Server

```bash
npx inngest-cli@latest dev
```

This starts the Inngest Dev Server at:
- **Dashboard**: http://localhost:8288
- **Webhook**: http://localhost:8288/api/inngest

### 2. Start Next.js Dev Server

```bash
npm run dev
```

Your Next.js app will be available at:
- **App**: http://localhost:3000
- **Inngest API**: http://localhost:3000/api/inngest

### 3. Test the Integration

#### Option A: Via Enrollment API

```bash
curl -X POST http://localhost:3000/api/enrollments \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@ceremonia.com",
    "firstName": "Test",
    "lastName": "User",
    "eventId": "your-event-id"
  }'
```

#### Option B: Via Test Script

```bash
# Test pre-event funnel
npx tsx scripts/test-inngest.ts pre-event

# Test post-event funnel
npx tsx scripts/test-inngest.ts post-event

# Test direct message send
npx tsx scripts/test-inngest.ts message

# Run all tests
npx tsx scripts/test-inngest.ts all
```

### 4. View Jobs in Dashboard

Open http://localhost:8288 to see:
- Running functions
- Function execution logs
- Event payload details
- Retry attempts
- Step-by-step execution

## Database Tables

### `sent_messages`

Tracks all message sends with engagement metrics.

**Key Fields:**
- `contact_id` - Recipient contact
- `registration_id` - Related event registration
- `campaign_id` - Related campaign (optional)
- `template_id` - Message template used
- `channel` - email, sms, whatsapp, etc.
- `provider` - resend, twilio, etc.
- `status` - queued, sent, delivered, opened, clicked, etc.
- `sent_at`, `delivered_at`, `opened_at` - Timestamps
- `body_text`, `body_html` - Rendered content

### `registrations.reminders_sent`

JSONB array tracking which reminders were sent:

```json
[
  {
    "type": "24h",
    "sent_at": "2025-09-30T10:00:00Z",
    "channel": "email",
    "message_id": "uuid"
  },
  {
    "type": "1h",
    "sent_at": "2025-09-30T11:00:00Z",
    "channel": "sms",
    "message_id": "uuid"
  }
]
```

## Error Handling

### Retry Policy

All functions use a 4-attempt retry policy:
- Attempt 1: Immediate
- Attempt 2: +1 minute
- Attempt 3: +5 minutes
- Attempt 4: +30 minutes

### Dead Letter Queue (DLQ)

After 4 failed attempts, jobs are moved to Inngest's DLQ:
- View in Inngest dashboard
- Manual replay available
- Alerts can be configured

### Error Logging

All errors are logged with structured data:
```typescript
console.error('[function-name] Error description:', error);
```

### Database Tracking

Failed messages are recorded in `sent_messages` with:
- `status: 'failed'`
- `error_code` - Error code from provider
- `error_message` - Detailed error message

## Production Deployment

### 1. Set Environment Variables

Add to your production environment (Vercel, Railway, etc.):

```bash
INNGEST_EVENT_KEY=prod_...
INNGEST_SIGNING_KEY=signkey-prod-...
```

### 2. Configure Inngest Cloud

1. Go to https://app.inngest.com
2. Create a new app or use existing
3. Add environment (production)
4. Get signing key and event key
5. Configure webhook: `https://yourdomain.com/api/inngest`

### 3. Deploy Application

```bash
# Example for Vercel
vercel --prod

# Example for Railway
railway up
```

### 4. Verify Integration

1. Check Inngest dashboard for registered functions
2. Trigger a test enrollment
3. Monitor function execution in dashboard
4. Check database for `sent_messages` records

## Monitoring & Debugging

### Inngest Dashboard

**Local:** http://localhost:8288
**Production:** https://app.inngest.com

**Features:**
- Real-time function execution
- Step-by-step debugging
- Event payload inspection
- Retry history
- Performance metrics

### Database Queries

**View recent message sends:**
```sql
SELECT
  sm.id,
  c.email,
  sm.channel,
  sm.status,
  mt.slug AS template,
  sm.sent_at,
  sm.delivered_at
FROM sent_messages sm
JOIN contacts c ON sm.contact_id = c.id
LEFT JOIN message_templates mt ON sm.template_id = mt.id
ORDER BY sm.created_at DESC
LIMIT 20;
```

**View registrations with reminders:**
```sql
SELECT
  r.id,
  c.email,
  e.title,
  r.reminders_sent
FROM registrations r
JOIN contacts c ON r.contact_id = c.id
JOIN events e ON r.event_id = e.id
WHERE r.reminders_sent != '[]'::jsonb
ORDER BY r.created_at DESC;
```

### Application Logs

Search for Inngest-related logs:
```bash
# Pre-event funnel
grep "pre-event-funnel" logs/*.log

# Post-event funnel
grep "post-event-funnel" logs/*.log

# Message sends
grep "send-message" logs/*.log
```

## Success Criteria Checklist

- ✅ Inngest client configured and initialized
- ✅ API route `/api/inngest` created and serving functions
- ✅ `event.enrolled` trigger integrated into enrollment endpoint
- ✅ Pre-event funnel function with 3-step sequence
- ✅ Post-event funnel with branching logic (attended vs no-show)
- ✅ Message sender function logs messages (ready for Resend/Twilio)
- ✅ Database helpers for `sent_messages` table
- ✅ Test script for manual event triggering
- ✅ Idempotency working (duplicate events don't create duplicate jobs)
- ✅ Consent checking for email and SMS
- ✅ Event validation before sending reminders
- ✅ Retry policy with exponential backoff

## Next Steps

1. **Email Integration (Resend)**
   - Add Resend API key to environment
   - Update `send-message.ts` to use Resend SDK
   - Implement webhook handler for delivery tracking

2. **SMS Integration (Twilio)**
   - Add Twilio credentials to environment
   - Update `send-message.ts` to use Twilio SDK
   - Handle STOP/START/HELP responses

3. **Webhook Handlers**
   - Create `/api/webhooks/resend` for email events
   - Create `/api/webhooks/twilio` for SMS events
   - Create `/api/webhooks/zoom` for attendance tracking

4. **Content API Integration**
   - Fetch generated content from external API
   - Cache content in `message_templates` table
   - Implement fallback for API failures

5. **Testing**
   - Write integration tests for all functions
   - Test retry behavior with intentional failures
   - Validate idempotency with duplicate events
   - Load test with concurrent enrollments

## Support

For issues or questions:
- **Inngest Docs**: https://www.inngest.com/docs
- **Inngest Discord**: https://www.inngest.com/discord
- **Project Issues**: GitHub Issues

---

**Implementation Date:** 2025-09-30
**Author:** Claude (Anthropic)
**Status:** Ready for Testing
